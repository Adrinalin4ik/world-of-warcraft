{"version":3,"file":"index.js","names":["_crypto","_interopRequireDefault","require","_fs","_temp","_cLib","_blpLib","_mipmap","obj","__esModule","_typeof","Symbol","iterator","constructor","prototype","_classCallCheck","instance","Constructor","TypeError","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","_toPropertyKey","key","_createClass","protoProps","staticProps","_defineProperty","value","arg","_toPrimitive","String","input","hint","prim","toPrimitive","undefined","res","call","Number","BLP","path","handle","file","mipmaps","mipmapCount","push","Mipmap","close","BLPLib","blp_release","CLib","fclose","match","TMP_PREFIX","fs","unlinkSync","get","blp_version","blp_nbMipLevels","open","callback","fopen","isNull","blp_processFile","blp","Error","from","buffer","tmp","temp","prefix","writeFileSync","e","concat","crypto","randomBytes","toString","_default","exports"],"sources":["../../src/lib/blp/index.js"],"sourcesContent":["import crypto from 'crypto';\nimport fs from 'fs';\nimport temp from 'temp';\n\nimport CLib from '../c-lib';\nimport BLPLib from './blp-lib';\nimport Mipmap from './mipmap';\n\nclass BLP {\n\n  static TMP_PREFIX = `blp-${crypto.randomBytes(6).toString('hex')}-`;\n\n  constructor(path, handle, file) {\n    this.path = path;\n    this.handle = handle;\n    this.file = file;\n\n    this.mipmaps = [];\n    for (let i = 0; i < this.mipmapCount; ++i) {\n      this.mipmaps.push(new Mipmap(this, i));\n    }\n  }\n\n  close() {\n    const handle = this.handle;\n    if (handle) {\n      this.handle = null;\n      BLPLib.blp_release(handle);\n    }\n\n    const file = this.file;\n    if (file) {\n      this.file = null;\n      CLib.fclose(file);\n\n      if (this.path.match(this.constructor.TMP_PREFIX)) {\n        fs.unlinkSync(this.path);\n      }\n    }\n  }\n\n  get opened() {\n    return !!this.file;\n  }\n\n  get version() {\n    return BLPLib.blp_version(this.handle);\n  }\n\n  get mipmapCount() {\n    return BLPLib.blp_nbMipLevels(this.handle);\n  }\n\n  get smallest() {\n    return this.mipmaps[this.mipmapCount - 1];\n  }\n\n  get largest() {\n    return this.mipmaps[0];\n  }\n\n  static open(path, callback) {\n    const file = CLib.fopen(path, 'r');\n    if (!file.isNull()) {\n      const handle = BLPLib.blp_processFile(file);\n      if (!handle.isNull()) {\n        const blp = new this(path, handle, file);\n        \n        if (callback) {\n          callback(blp);\n          blp.close();\n          return true;\n        }\n        \n        return blp;\n      }\n      CLib.fclose(file);\n      throw new Error('image could not be opened');\n    }\n    throw new Error('image could not be found');\n  }\n\n  static from(buffer, callback) {\n    const tmp = temp.path({ prefix: this.TMP_PREFIX });\n    fs.writeFileSync(tmp, buffer);\n    try {\n      return this.open(tmp, callback);\n    } catch (e) {\n      fs.unlinkSync(tmp);\n      throw e;\n    }\n  }\n\n}\n\nexport default BLP;\n"],"mappings":"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"}