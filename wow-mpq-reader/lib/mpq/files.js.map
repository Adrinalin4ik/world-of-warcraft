{"version":3,"file":"files.js","names":["_refNapi","_interopRequireDefault","require","_file","_stormLib","_interopRequireWildcard","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","_typeof","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","Symbol","iterator","constructor","_classCallCheck","instance","Constructor","TypeError","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","_toPropertyKey","_createClass","protoProps","staticProps","_defineProperty","value","arg","_toPrimitive","String","input","hint","prim","toPrimitive","undefined","res","Number","Files","mpq","handle","contains","file","StormLib","SFileHasFile","fileHandlePtr","ref","alloc","HANDLEPtr","SFileOpenFileEx","FROM_MPQ","File","deref","extract","SFileExtractFile","errno","GetLastError","Error","concat","find","pattern","_this","next","data","FIND_DATA","SFileFindFirstFile","isNull","SFileFindNextFile","results","push","SFileFindClose","_default","exports"],"sources":["../../src/lib/mpq/files.js"],"sourcesContent":["import ref from 'ref-napi';\n\nimport File from './file';\nimport { default as StormLib, FIND_DATA, HANDLEPtr } from './storm-lib';\n\nclass Files {\n\n  static FROM_MPQ   = 0x00000000;\n  static FROM_LOCAL = 0xFFFFFFFF;\n\n  constructor(mpq) {\n    this.mpq = mpq;\n  }\n\n  get handle() {\n    return this.mpq.handle;\n  }\n\n  contains(file) {\n    return !!this.handle && StormLib.SFileHasFile(this.handle, file);\n  }\n\n  get(file) {\n    if (this.handle) {\n      const fileHandlePtr = ref.alloc(HANDLEPtr);\n      if (StormLib.SFileOpenFileEx(this.handle, file, this.constructor.FROM_MPQ, fileHandlePtr)) {\n        return new File(fileHandlePtr.deref());\n      }\n    }\n    return null;\n  }\n\n  extract(file, target) {\n    if (!StormLib.SFileExtractFile(this.handle, file, target, this.constructor.FROM_MPQ)) {\n      const errno = StormLib.GetLastError();\n      throw new Error(`file could not be extracted (${errno})`);\n    }\n    return true;\n  }\n\n  get all() {\n    return this.find('*');\n  }\n\n  find(pattern) {\n    let handle = null;\n\n    const next = () => {\n      const data = new FIND_DATA();\n      if (!handle) {\n        handle = StormLib.SFileFindFirstFile(this.handle, pattern, data.ref(), null);\n        if (!handle.isNull()) {\n          return data;\n        }\n      } else {\n        if (StormLib.SFileFindNextFile(handle, data.ref())) {\n          return data;\n        }\n      }\n    };\n\n    const results = [];\n    let data;\n    while (data = next()) {\n      results.push(data);\n    }\n\n    StormLib.SFileFindClose(handle);\n    return results;\n  }\n\n}\n\nexport default Files;\n"],"mappings":"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"}